# 開発日誌 - 2025年7月31日

## プロジェクト: leaving-work-api

### 今日の作業内容

#### 1. データベース設定とPOSTメソッドの実装
- PostgreSQLをDocker Composeで構築
- データベース接続設定（db/db.go）の実装
- POSTメソッドでの退勤記録作成機能を追加

#### 2. マイグレーションファイルの作成
- `work_records`テーブルの作成
- 初期データの投入
- `users`テーブルの作成（新規追加）

#### 3. リポジトリパターンの改善
- `work_record_repository.go`でデータベース操作を分離
- モデルとリクエスト構造体の分離（model/request.go）

### 遭遇した問題と解決

#### Docker関連
- **問題**: `Cannot connect to the Docker daemon at unix:///var/run/docker.sock`
- **原因**: WSL2環境でDockerデーモンが起動していない
- **解決**: Docker Desktop for Windowsの起動、またはWSL2内で`sudo service docker start`

#### マイグレーションエラー
1. **SQL文法エラー**
   - **問題**: `syntax error at or near "name"`
   - **原因**: VARCHARに長さ指定がない
   - **解決**: `VARCHAR` → `VARCHAR(255)`に修正

2. **Dirty database state**
   - **問題**: `Dirty database version 20250731131420`
   - **原因**: マイグレーションが途中で失敗
   - **解決方法**: 
     ```bash
     migrate -path db/migrations -database "postgresql://postgres:password@localhost:5432/leaving_work?sslmode=disable" force 20250731131420
     ```

### 技術的な学び

1. **golang-migrate**の使用方法
   - マイグレーションファイルの命名規則: `{timestamp}_{description}.{up|down}.sql`
   - forceコマンドでdirty stateを解決できる

2. **PostgreSQLの注意点**
   - VARCHARには必ず長さ指定が必要
   - schema_migrationsテーブルでマイグレーション状態を管理

3. **Docker Compose環境**
   - コンテナ名: `leaving-work-db`
   - 接続方法: `docker exec -it leaving-work-db psql -U postgres -d leaving_work`

### 明日の予定
- マイグレーションツールの正式な統合（Makefileの作成）
- エラーハンドリングの改善
- ユーザー認証機能の実装（usersテーブルを利用）

### コミット履歴
- 9a77a52 DBを設定し、POSTメソッドの追加をする
- cf383be バリデーション導入  
- 7bfd3db 責務を分ける
- 3e2734e 仮APIを実装